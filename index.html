<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiplayer Clicker Game</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        #counter {
            font-size: 2em;
            margin-bottom: 20px;
        }
        #clickButton {
            padding: 10px 20px;
            font-size: 1.5em;
            cursor: pointer;
        }
        .cursor {
            position: absolute;
            pointer-events: none;
            background-image: url('/hand.png');
            background-size: cover;
            width: 17px; /* Adjust based on your image size */
            height: 23px; /* Adjust based on your image size */
        }
        .username {
            font-size: 0.8em;
            margin-top: -20px;
            color: black;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        }
        #chatContainer {
            position: fixed;
            bottom: 60px;
            left: 20px;
            width: 300px;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ccc;
            padding: 10px;
            color: black;
            font-size: 0.9em;
        }
        #chatInputContainer {
            position: fixed;
            bottom: 0;
            left: 20px;
            width: 300px;
            display: flex;
            background: white;
            border-top: 1px solid #ccc;
        }
        #chatInput {
            flex: 1;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            color: black;
        }
        #chatSendButton {
            padding: 5px 10px;
            border: 1px solid #ccc;
            background: #007BFF;
            color: white;
            cursor: pointer;
            border-radius: 4px;
            margin-left: 5px;
        }
        #usernameInputContainer {
            position: fixed;
            top: 20px;
            left: 20px;
            display: flex;
            background: white;
            border: 1px solid #ccc;
            padding: 5px;
        }
        #usernameInput {
            flex: 1;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            color: black;
        }
        #usernameUpdateButton {
            padding: 5px 10px;
            border: 1px solid #ccc;
            background: #28A745;
            color: white;
            cursor: pointer;
            border-radius: 4px;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div id="counter">0</div>
    <button id="clickButton">Click Me!</button>
    
    <div id="chatContainer"></div>
    <div id="chatInputContainer">
        <input id="chatInput" type="text" placeholder="Type a message...">
        <button id="chatSendButton">Send</button>
    </div>
    
    <div id="usernameInputContainer">
        <input id="usernameInput" type="text" placeholder="Enter new username...">
        <button id="usernameUpdateButton">Update</button>
    </div>

    <script type="module">
        import { joinRoom, selfId } from '/trystero-torrent.min.js';

        const appId = 'multiplayer_clicker_game';
        const room = joinRoom({ appId }, 'clicker_room');

        const counterElement = document.getElementById('counter');
        const clickButton = document.getElementById('clickButton');
        const chatContainer = document.getElementById('chatContainer');
        const chatInput = document.getElementById('chatInput');
        const chatSendButton = document.getElementById('chatSendButton');
        const usernameInput = document.getElementById('usernameInput');
        const usernameUpdateButton = document.getElementById('usernameUpdateButton');
        
        let counter = 0;
        let username = 'User' + selfId.slice(0, 4); // Default username

        const peerCursors = {};

        // Shorten action names
        const [sendCounter, getCounter] = room.makeAction('cnt');
        const [sendCursor, getCursor] = room.makeAction('cur');
        const [sendChat, getChat] = room.makeAction('chat');
        const [sendUsername, getUsername] = room.makeAction('uname');

        // Function to update the counter, ensuring it only increases
        function updateCounter(newCounter) {
            if (newCounter > counter) {
                counter = newCounter;
                counterElement.textContent = counter;
            }
        }

        // Handle button click
        clickButton.addEventListener('click', () => {
            updateCounter(counter + 1); // Increment locally
            sendCounter(counter + 1);   // Broadcast the updated counter
        });

        // Handle receiving updated counter from peers
        getCounter((newCounter, peerId) => {
            updateCounter(newCounter); // Update only if the new value is higher
        });

        // Handle peer cursor movement
        getCursor(({ x, y, peerId, username: peerUsername }) => {
            let cursor = peerCursors[peerId];
            if (!cursor) {
                cursor = document.createElement('div');
                cursor.className = 'cursor';
                cursor.innerHTML = `<div class="username">${peerUsername}</div>`;
                document.body.appendChild(cursor);
                peerCursors[peerId] = cursor;
            }
            cursor.style.left = `${x}px`;
            cursor.style.top = `${y}px`;
        });

        // Send cursor position to peers
        document.addEventListener('mousemove', (e) => {
            const x = e.clientX;
            const y = e.clientY;
            sendCursor({ x, y, peerId: selfId, username });
        });

        // Listen for peers joining
        room.onPeerJoin(peerId => console.log(`${peerId} joined`));

        // Listen for peers leaving
        room.onPeerLeave(peerId => {
            console.log(`${peerId} left`);
           
